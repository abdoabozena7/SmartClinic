<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Appointment Booking - Scheduling System</title>
  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #f0fbf9 0%, #f7faff 100%);
      margin: 0;
      padding: 20px;
      color: #0f172a;
    }
    h1 {
      text-align: center;
      color: #0ea5a4;
      letter-spacing: .3px;
      text-shadow: 0 1px 0 rgba(255,255,255,.8);
      margin: 0 0 12px;
      line-height: 1.2;
    }
    section {
      background-color: #fff;
      padding: 18px;
      margin-bottom: 22px;
      border-radius: 14px;
      border: 1px solid #d9f2ee;
      box-shadow: 0 6px 18px rgba(14,165,164,.10), 0 1px 0 rgba(14,165,164,.08) inset;
      transition: box-shadow .2s ease, transform .2s ease;
    }
    section:hover { box-shadow: 0 10px 24px rgba(14,165,164,.15); transform: translateY(-1px); }

    label {
      display: block;
      margin-top: 12px;
      font-weight: 700;
      color: #075985;
    }

    select, input {
      display: inline-block;
      inline-size: fit-content;
      min-inline-size: 220px;
      max-inline-size: 460px;
      padding: 10px 12px;
      margin-top: 6px;
      border: 1.5px solid #c7ece7;
      border-radius: 10px;
      background: #fbfffe;
      box-sizing: border-box;
      outline: none;
      transition: border-color .2s ease, box-shadow .2s ease, background .2s ease;
    }
    input[type="date"] { min-inline-size: 180px; }
    select:focus, input:focus {
      border-color: #0ea5a4;
      box-shadow: 0 0 0 4px rgba(14,165,164,.15);
      background: #ffffff;
    }

    button {
      margin-top: 14px;
      padding: 10px 18px;
      background-image: linear-gradient(180deg, #14b8a6, #0ea5a4);
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      letter-spacing: .2px;
      box-shadow: 0 6px 14px rgba(20,184,166,.25);
      transition: transform .1s ease, box-shadow .2s ease, filter .2s ease, background .2s ease;
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 10px 18px rgba(20,184,166,.28); filter: brightness(1.02); }
    button:active { transform: translateY(0); }

    #backToAdminBtn { background-image: linear-gradient(180deg, #38bdf8, #0ea5e9) !important; }
    #logoutBtn { background-image: linear-gradient(180deg, #ef4444, #dc2626) !important; }

    .message { margin-top: 10px; color: #059669; font-weight: 700; }
    .error   { margin-top: 10px; color: #b91c1c; font-weight: 700; }

    .slots {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .slot-button {
      color: #000;
      padding: 8px 12px;
      background: #e6fffb;
      border: 1px solid #c7ece7;
      border-radius: 10px;
      cursor: pointer;
      transition: box-shadow .2s ease, transform .1s ease, background .2s ease, border-color .2s ease;
    }
    .slot-button:hover { background: #e9e9e9; box-shadow: 0 4px 10px rgba(14,165,164,.12); transform: translateY(-1px); }
    .slot-button.selected { background: #0ea5a4; color: #000000; border-color: #0ea5a4; }

    @media (max-width: 640px) {
      section { padding: 14px; }
      button { width: 100%; }
      select, input {
        inline-size: 100%;
        max-inline-size: 100%;
        min-inline-size: 0;
      }
    }
  </style>
</head>
<body>
  <h1>Book an Appointment</h1>
  <p id="welcome"></p>
  <div style="margin-bottom: 10px;">
    <button id="backToAdminBtn" style="display:none; background-color:#9c27b0; color:#fff; margin-left:10px;">Back to Admin Panel</button>
    <button id="logoutBtn" style="background-color:#f44336; color:#fff;">Log Out</button>
  </div>
  <section>
    <h2>Select Doctor and Service</h2>
    <form id="bookingForm">
      <label for="patientDoctorSelect">Choose Doctor</label>
      <select id="patientDoctorSelect" required>
        <option value="">-- Choose Doctor --</option>
      </select>
      <label for="patientServiceSelect">Choose Service</label>
      <select id="patientServiceSelect" required>
        <option value="">-- Choose Service --</option>
      </select>
      <label for="patientDate">Date</label>
      <input type="date" id="patientDate" required>
      <label>Available Slots</label>
      <div class="slots" id="slotsContainer">
        <!-- Time slot buttons will be injected here -->
      </div>
      <input type="hidden" id="selectedTime" name="selectedTime">
      <button type="submit">Book Appointment</button>
      <div class="message" id="bookingSuccess" style="display:none;"></div>
      <div class="error" id="bookingError" style="display:none;"></div>
    </form>
  </section>
</body>
</html>
<script>
  const user = JSON.parse(localStorage.getItem('user') || '{}');
  const simulate = localStorage.getItem('simulateAsPatient') === 'true';
  if (!user || (user.role !== 'patient' && !simulate)) {
    window.location.href = 'login.html';
  } else {
    document.getElementById('welcome').textContent = `Welcome, ${user.email}`;
    if (simulate) {
      document.getElementById('backToAdminBtn').style.display = 'inline-block';
    }
  }

  async function loadDoctors() {
    const res = await fetch('/api/doctors');
    const docs = await res.json();
    const select = document.getElementById('patientDoctorSelect');
    select.innerHTML = '<option value="">Choose doctor</option>';
    docs.forEach(doc => {
      const opt = document.createElement('option');
      opt.value = doc.id;
      opt.textContent = doc.name;
      opt.dataset.services = JSON.stringify(doc.services);
      select.appendChild(opt);
    });
  }

  document.getElementById('patientDoctorSelect').addEventListener('change', function() {
    const selected = this.options[this.selectedIndex];
    const services = selected.dataset.services ? JSON.parse(selected.dataset.services) : [];
    const serviceSelect = document.getElementById('patientServiceSelect');
    serviceSelect.innerHTML = '<option value="">-- Choose Service --</option>';
    services.forEach(svc => {
      const opt = document.createElement('option');
      opt.value = svc;
      opt.textContent = svc;
      serviceSelect.appendChild(opt);
    });
    document.getElementById('slotsContainer').innerHTML = '';
    document.getElementById('selectedTime').value = '';
  });

  document.getElementById('patientDate').addEventListener('change', fetchAvailableSlots);
  document.getElementById('patientServiceSelect').addEventListener('change', fetchAvailableSlots);

  async function fetchAvailableSlots() {
    const doctorId = document.getElementById('patientDoctorSelect').value;
    const date = document.getElementById('patientDate').value;
    const service = document.getElementById('patientServiceSelect').value;
    const container = document.getElementById('slotsContainer');
    container.innerHTML = '';
    document.getElementById('selectedTime').value = '';
    if (!doctorId || !date || !service) {
      return;
    }
    try {
      const res = await fetch(`/api/doctors/${doctorId}/available?date=${date}`);
      const slots = await res.json();
      const filtered = slots.filter(slot => slot.service === service);
      if (filtered.length === 0) {
        container.textContent = 'No available slots for this date.';
        return;
      }
      filtered.forEach(slot => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'slot-button';
        btn.textContent = slot.time;
        btn.dataset.time = slot.time;
        btn.addEventListener('click', function() {
          document.querySelectorAll('.slot-button').forEach(b => b.classList.remove('selected'));
          this.classList.add('selected');
          document.getElementById('selectedTime').value = this.dataset.time;
        });
        container.appendChild(btn);
      });
    } catch (err) {
      container.textContent = 'Failed to load slots.';
    }
  }

  document.getElementById('bookingForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const doctorId = document.getElementById('patientDoctorSelect').value;
    const date = document.getElementById('patientDate').value;
    const time = document.getElementById('selectedTime').value;
    const service = document.getElementById('patientServiceSelect').value;
    const success = document.getElementById('bookingSuccess');
    const error = document.getElementById('bookingError');
    success.style.display = 'none';
    error.style.display = 'none';
    if (!doctorId || !date || !time || !service) {
      error.textContent = 'Please select all fields.';
      error.style.display = 'block';
      return;
    }
    try {
      const res = await fetch('/api/bookings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ doctorId, date, time, patientEmail: user.email })
      });
      const data = await res.json();
      if (res.ok) {
        success.textContent = 'Appointment booked successfully.';
        success.style.display = 'block';
        document.getElementById('slotsContainer').innerHTML = '';
        document.getElementById('selectedTime').value = '';
        await fetchAvailableSlots();
      } else {
        error.textContent = data.error || 'Error during booking.';
        error.style.display = 'block';
      }
    } catch (err) {
      error.textContent = 'Failed to connect to the server.';
      error.style.display = 'block';
    }
  });

  loadDoctors();

  document.getElementById('logoutBtn').addEventListener('click', function() {
    localStorage.removeItem('user');
    localStorage.removeItem('simulateAsPatient');
    window.location.href = 'login.html';
  });

  document.getElementById('backToAdminBtn').addEventListener('click', function() {
    localStorage.removeItem('simulateAsPatient');
    window.location.href = 'admin.html';
  });
</script>
</body>
</html>
