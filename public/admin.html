<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f7f7f7;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    section {
      background-color: #fff;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      background-color: #4CAF50;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    .message {
      margin-top: 10px;
      color: #4CAF50;
    }
    .error {
      margin-top: 10px;
      color: #f44336;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body>
  <h1>Admin Panel</h1>
  <p id="welcome"></p>
  <div style="margin-bottom: 10px;">
    <button id="simulateBtn" style="margin-left: 10px; background-color:#2196F3;">Simulate as Patient</button>
    <button id="logoutBtn" style="background-color:#f44336;">Logout</button>
  </div>
  <section>
    <h2>Add New Doctor</h2>
    <form id="addDoctorForm">
      <label for="doctorName">Doctor Name</label>
      <input type="text" id="doctorName" name="doctorName" required placeholder="Doctor Name">
      <label for="doctorServices">Services (comma-separated)</label>
      <input type="text" id="doctorServices" name="doctorServices" required placeholder="e.g., Extraction, Filling, Whitening">
      <button type="submit">Add</button>
      <div class="message" id="doctorSuccess" style="display:none;"></div>
      <div class="error" id="doctorError" style="display:none;"></div>
    </form>
  </section>

  <section>
    <h2>Add Timeslots for Doctor</h2>
    <form id="addTimeslotForm">
      <label for="doctorSelect">Select Doctor</label>
      <select id="doctorSelect" required>
        <option value="">-- Select Doctor --</option>
      </select>
      <label for="serviceSelect">Select Service</label>
      <select id="serviceSelect" required>
        <option value="">-- Select Service --</option>
      </select>
      <label for="dateInput">Date</label>
      <input type="date" id="dateInput" required>
      <label>Available Times</label>
      <div id="timesContainer">
        <input type="time" class="time-input" required>
      </div>
      <button type="button" id="addTimeBtn" style="margin-top:10px;background-color:#607d8b;">Add Time</button>
      <button type="submit" style="display:block;margin-top:10px;">Add Timeslots</button>
      <div class="message" id="timeslotSuccess" style="display:none;"></div>
      <div class="error" id="timeslotError" style="display:none;"></div>
    </form>
  </section>

  <section>
    <h2>All Booked Appointments</h2>
    <button id="refreshAppointments">Refresh List</button>
    <table id="appointmentsTable">
      <thead>
        <tr>
          <th>Doctor</th>
          <th>Service</th>
          <th>Date</th>
          <th>Time</th>
          <th>Patient Email</th>
        </tr>
      </thead>
      <tbody id="appointmentsBody">
      </tbody>
    </table>
  </section>

  <script>
    // Check login
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    if (!user || user.role !== 'admin') {
      window.location.href = 'login.html';
    } else {
      document.getElementById('welcome').textContent = `Welcome, ${user.email}`;
    }

    // Load doctors into select
    async function loadDoctors() {
      const res = await fetch('/api/doctors');
      const list = await res.json();
      const select = document.getElementById('doctorSelect');
      select.innerHTML = '<option value="">-- Select Doctor --</option>';
      list.forEach(doc => {
        const option = document.createElement('option');
        option.value = doc.id;
        option.textContent = doc.name;
        option.dataset.services = JSON.stringify(doc.services);
        select.appendChild(option);
      });
    }

    // Update service select when doctor changes
    document.getElementById('doctorSelect').addEventListener('change', function() {
      const selected = this.options[this.selectedIndex];
      const services = selected.dataset.services ? JSON.parse(selected.dataset.services) : [];
      const serviceSelect = document.getElementById('serviceSelect');
      serviceSelect.innerHTML = '<option value="">-- Select Service --</option>';
      services.forEach(svc => {
        const opt = document.createElement('option');
        opt.value = svc;
        opt.textContent = svc;
        serviceSelect.appendChild(opt);
      });
    });

    // Add doctor form submission
    document.getElementById('addDoctorForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const name = document.getElementById('doctorName').value.trim();
      const servicesStr = document.getElementById('doctorServices').value.trim();
      const services = servicesStr.split(',').map(s => s.trim()).filter(s => s);
      const success = document.getElementById('doctorSuccess');
      const error = document.getElementById('doctorError');
      success.style.display = 'none';
      error.style.display = 'none';
      try {
        const res = await fetch('/api/doctors', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, services })
        });
        const data = await res.json();
        if (res.ok) {
          success.textContent = 'Doctor added successfully.';
          success.style.display = 'block';
          this.reset();
          await loadDoctors();
        } else {
          error.textContent = data.error || 'Error adding doctor.';
          error.style.display = 'block';
        }
      } catch (err) {
        error.textContent = 'Failed to connect to the server.';
        error.style.display = 'block';
      }
    });

    // Add timeslot form submission
    document.getElementById('addTimeslotForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const doctorId = document.getElementById('doctorSelect').value;
      const service = document.getElementById('serviceSelect').value;
      const date = document.getElementById('dateInput').value;
      const timeInputs = document.querySelectorAll('#timesContainer .time-input');
      const times = Array.from(timeInputs).map(input => input.value.trim()).filter(t => t);
      const success = document.getElementById('timeslotSuccess');
      const error = document.getElementById('timeslotError');
      success.style.display = 'none';
      error.style.display = 'none';
      if (!doctorId || !service || !date || times.length === 0) {
        error.textContent = 'Please fill in all fields.';
        error.style.display = 'block';
        return;
      }
      try {
        const res = await fetch(`/api/doctors/${doctorId}/timeslots`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ date, times, service })
        });
        const data = await res.json();
        if (res.ok) {
          success.textContent = 'Timeslots added successfully.';
          success.style.display = 'block';
          this.reset();
        } else {
          error.textContent = data.error || 'Error adding timeslots.';
          error.style.display = 'block';
        }
      } catch (err) {
        error.textContent = 'Failed to connect to the server.';
        error.style.display = 'block';
      }
    });

    // Load appointments and display
    async function loadAppointments() {
      const tbody = document.getElementById('appointmentsBody');
      tbody.innerHTML = '';
      try {
        const res = await fetch('/api/appointments');
        const list = await res.json();
        list.forEach(app => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${app.doctorName}</td>
            <td>${app.service}</td>
            <td>${app.date}</td>
            <td>${app.time}</td>
            <td>${app.patientEmail}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="5">Failed to load appointments.</td>`;
        tbody.appendChild(tr);
      }
    }

    document.getElementById('refreshAppointments').addEventListener('click', loadAppointments);

    // Initial load
    loadDoctors().then(loadAppointments);

    // Logout handler
    document.getElementById('logoutBtn').addEventListener('click', function() {
      localStorage.removeItem('user');
      localStorage.removeItem('simulateAsPatient');
      window.location.href = 'login.html';
    });

    // Simulate as patient handler
    document.getElementById('simulateBtn').addEventListener('click', function() {
      localStorage.setItem('simulateAsPatient', 'true');
      window.location.href = 'patient.html';
    });

    // Add time input fields dynamically
    document.getElementById('addTimeBtn').addEventListener('click', function() {
      const container = document.getElementById('timesContainer');
      const input = document.createElement('input');
      input.type = 'time';
      input.className = 'time-input';
      input.required = true;
      container.appendChild(input);
    });
  </script>
</body>
</html>
